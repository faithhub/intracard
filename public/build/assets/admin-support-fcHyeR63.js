import{r as e,c as t,S as a,U as s,w as l,V as n,L as i,z as o,C as r,O as c,G as d,E as u,v as m,D as g,K as p,H as f,F as v,A as h,W as y,y as k,X as w,J as _,n as x,R as T,Q as b}from"./vendor-DWrK2g1_.js";import{_ as C,V as S,b as E,e as M,f as F,g as D,h as z,i as U,j as I,k as V,l as $,m as j,n as A,o as R,p as L,q as H,r as O,s as N,t as P,u as q,v as G,w as K,x as B,y as Q,z as J,A as W,B as X,C as Y,a as Z,c as ee,d as te}from"./main-DhXQbgH3.js";const ae={class:"ticket-list flex-grow-1 overflow-auto"},se={key:0,class:"d-flex justify-center py-6"},le={key:1,class:"text-center pa-4 text-body-2 text-medium-emphasis"},ne={class:"d-flex flex-column align-end"},ie={class:"text-caption text-medium-emphasis mb-1"},oe={class:"text-center"},re={class:"flex-grow-1"},ce={class:"text-h6 mb-1"},de={class:"d-flex flex-column"},ue={class:"d-flex align-center mb-1"},me={class:"text-caption text-medium-emphasis"},ge={class:"text-caption text-medium-emphasis"},pe={ref:"messagesContainer",class:"messages-container flex-grow-1 overflow-auto pa-6"},fe={key:0,class:"d-flex justify-center py-6"},ve={key:1,class:"text-center"},he={class:"date-separator text-center my-6"},ye={class:"text-caption bg-grey-lighten-3 px-3 py-1 rounded"},ke=["innerHTML"],we={key:1,class:"mt-2"},_e={key:0,class:"text-center mb-2"},xe={class:"text-caption font-weight-medium mr-2"},Te={class:"text-caption text-medium-emphasis"},be={key:0,class:"selected-file mb-2 pa-2 rounded bg-grey-lighten-4 d-flex align-center"},Ce={class:"flex-grow-1"},Se={class:"text-body-2"},Ee={class:"text-caption"},Me={class:"d-flex align-center"},Fe={class:"d-flex align-center"};const De=C({name:"AdminSupportChat",setup(){const n=e([]),i=e([]),o=e(null),r=e([]),c=e(""),d=e(!1),u=e(!1),m=e(!1),g=e(""),p=e(""),f=e(null),v=e(null),h=e(null),y=e(null),k=e(!1),w=e("resolved"),_=e(""),T=e(!1),b=t((()=>o.value&&n.value.find((e=>e.uuid===o.value))||null)),C=t((()=>{const e={};return i.value.forEach((t=>{const a=new Date(t.created_at).toLocaleDateString();e[a]||(e[a]=[]),e[a].push(t)})),e})),S=async()=>{const e=o.value;d.value=!0;try{const t=await Z.get("/admin/api/tickets",{params:{status:p.value,search:g.value}});n.value=t.data.data,e&&n.value.some((t=>t.uuid===e))&&(o.value=e),E()}catch(t){console.error("Error loading tickets:",t),D("Error loading tickets. Please try again.","error")}finally{d.value=!1}},E=async()=>{try{const e=(await Z.get("/admin/api/unread-messages")).data.tickets||{};n.value=n.value.map((t=>({...t,unread_count:e[t.uuid]||0})))}catch(e){console.error("Error loading unread counts:",e)}},M=async e=>{u.value=!0;try{const t=await Z.get(`/admin/api/tickets/${e}/messages`);i.value=t.data,await x(),v.value&&(v.value.scrollTop=v.value.scrollHeight)}catch(t){console.error("Error loading messages:",t),D("Error loading messages. Please try again.","error")}finally{u.value=!1}},F=(()=>{let e;return()=>{clearTimeout(e),e=setTimeout((()=>{S()}),500)}})(),D=(e,t="success")=>{"undefined"!=typeof toastr?"success"===t?toastr.success(e,"Success"):"error"===t||"danger"===t?toastr.error(e,"Error"):"warning"===t?toastr.warning(e,"Warning"):"info"===t&&toastr.info(e,"Information"):console.log(`[${t.toUpperCase()}] ${e}`)},z=async e=>{if(void 0===window.Echo)return void console.error("Echo is not available");if(f.value)try{await window.Echo.leave(f.value)}catch(a){console.error("Error leaving channel:",a)}const t=`ticket.${e}`;f.value=t,console.log("window.Echo.channel(channelName):",window.Echo.channel(t));try{window.Echo.channel("channel_for_everyone").listen("GotMessage",(async e=>{console.log(`Successfully subscribed to ${t}`),console.log(e,"listening to MessageCreated")})).error((e=>{console.error(`Channel error on ${t}:`,e)}))}catch(s){console.error("Error subscribing to channel:",s)}};return a((()=>{window.Echo.channel("channel_for_everyone").listen("GotMessage",(e=>{console.log(e)})),window.Echo.channel("channel_for_everyone").listen(".GotMessage",(e=>{console.log(e)})),Echo.channel("channel_for_everyone").listen("GotMessage",(e=>{console.log("Received message via Echo:",e)})),S();const e=setInterval((()=>{E()}),6e4);s((()=>{clearInterval(e),f.value&&void 0!==window.Echo&&window.Echo.leave(f.value)}))})),l(p,(()=>{S()})),{tickets:n,messages:i,currentTicketUuid:o,selectedTicket:r,messageText:c,loading:d,loadingMessages:u,sendingMessage:m,searchQuery:g,statusFilter:p,messagesContainer:v,fileInput:h,selectedFile:y,showCloseDialog:k,closeTicketStatus:w,closeTicketReason:_,closingTicket:T,currentTicket:b,groupedMessages:C,statusOptions:[{title:"All Tickets",value:""},{title:"Pending",value:"pending"},{title:"Resolved",value:"resolved"},{title:"Unresolved",value:"unresolved"}],closeStatusOptions:[{title:"Resolved",value:"resolved"},{title:"Unresolved",value:"unresolved"}],formatExactDateTime:e=>{if(!e)return"";return new Date(e).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})},loadTickets:S,selectTicket:async e=>{o.value=e,r.value=[e],await M(e),void 0!==window.Echo&&z(e)},loadMessages:M,sendMessage:async()=>{if(c.value&&""!==c.value.trim()||y.value){m.value=!0;try{const e=new FormData;c.value&&e.append("message",c.value),y.value&&e.append("file",y.value);const t=await Z.post(`/admin/api/tickets/${o.value}/messages`,e,{headers:{"Content-Type":"multipart/form-data"}});i.value.push({...t.data.message,sender:t.data.sender}),c.value="",y.value=null,await x(),v.value&&(v.value.scrollTop=v.value.scrollHeight)}catch(e){console.error("Error sending message:",e),D("Error sending message. Please try again.","error")}finally{m.value=!1}}},updateTicketStatus:async e=>{try{await Z.put(`/admin/api/tickets/${o.value}/status`,{status:e});const t=n.value.find((e=>e.uuid===o.value));t&&(t.status=e),D(`Ticket marked as ${e}`,"success")}catch(t){console.error("Error updating ticket status:",t),D("Error updating ticket status. Please try again.","error")}},closeTicket:async()=>{if(_.value){T.value=!0;try{await Z.post(`/admin/api/tickets/${o.value}/close`,{resolution_status:w.value,reason:_.value});const e=n.value.find((e=>e.uuid===o.value));e&&(e.status=w.value),k.value=!1,_.value="",D("Ticket closed successfully","success")}catch(e){console.error("Error closing ticket:",e),D("Error closing ticket. Please try again.","error")}finally{T.value=!1}}else D("Please provide a resolution reason","warning")},formatMessageText:e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/\n/g,"<br>")},getStatusColor:e=>{switch(e){case"pending":return"warning";case"resolved":return"success";case"unresolved":return"error";default:return"grey"}},getInitial:e=>e?e.first_name&&e.first_name.length>0?e.first_name.charAt(0).toUpperCase():e.last_name&&e.last_name.length>0?e.last_name.charAt(0).toUpperCase():"U":"U",getInitialColor:e=>{const t=["primary","secondary","info","success","warning"];if(!e||!e.email)return t[0];return t[e.email.split("").reduce(((e,t)=>e+t.charCodeAt(0)),0)%t.length]},getCreatorName:e=>{if(!e)return"Unknown";let t="";return e.first_name&&(t+=e.first_name),e.last_name&&(t&&(t+=" "),t+=e.last_name),t||e.email||"Unknown"},formatDate:e=>{const t=new Date(e),a=new Date,s=new Date(a);return s.setDate(s.getDate()-1),t.toDateString()===a.toDateString()?"Today":t.toDateString()===s.toDateString()?"Yesterday":t.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric",year:"numeric"})},formatTime:e=>new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),getTimeAgo:e=>{if(!e)return"";const t=new Date(e),a=new Date,s=Math.floor((a-t)/1e3);if(s<60)return"Just now";const l=Math.floor(s/60);if(l<60)return`${l} min${l>1?"s":""} ago`;const n=Math.floor(l/60);if(n<24)return`${n} hour${n>1?"s":""} ago`;const i=Math.floor(n/24);return`${i} day${i>1?"s":""} ago`},isImageFile:e=>{if(!e)return!1;const t=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(t)},getFileIcon:e=>{if(!e)return"mdi-file";switch(e.split(".").pop().toLowerCase()){case"pdf":return"mdi-file-pdf";case"doc":case"docx":return"mdi-file-word";case"xls":case"xlsx":return"mdi-file-excel";case"zip":case"rar":case"7z":return"mdi-folder-zip";case"jpg":case"jpeg":case"png":case"gif":case"webp":return"mdi-file-image";default:return"mdi-file"}},formatFileSize:e=>e<1024?e+" bytes":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB",debounceSearch:F,triggerFileInput:()=>{h.value&&h.value.click()},onFileSelected:e=>{const t=e.target.files[0];t&&(t.size>10485760?D("File is too large. Maximum size is 10MB.","warning"):y.value=t)},removeSelectedFile:()=>{y.value=null,h.value&&(h.value.value=null)}}},directives:{"chat-scroll":{mounted(e,t){const a=t.value||{};e.scrollTop=e.scrollHeight;const s=new MutationObserver((()=>{(a.always||e.scrollTop+e.clientHeight+100>=e.scrollHeight)&&setTimeout((()=>{e.scrollTop=e.scrollHeight}),0)}));s.observe(e,{childList:!0,subtree:!0}),e._chatScrollObserver=s},unmounted(e){e._chatScrollObserver&&e._chatScrollObserver.disconnect()}}}},[["render",function(e,t,a,s,l,x){const T=n("chat-scroll");return i(),o(Y,null,{default:r((()=>[c(B,{fluid:"",class:"fill-height pa-0 w-100"},{default:r((()=>[c(S,{class:"rounded-lg elevation-2 fill-height overflow-hidden w-100"},{default:r((()=>[c(E,{class:"fill-height w-100"},{default:r((()=>[c(M,{cols:"12",sm:"5",md:"4",lg:"3",class:"ticket-sidebar"},{default:r((()=>[c(F,{class:"fill-height d-flex flex-column"},{default:r((()=>[c(F,{class:"pa-3 d-flex align-center"},{default:r((()=>[c(D,{modelValue:s.statusFilter,"onUpdate:modelValue":t[0]||(t[0]=e=>s.statusFilter=e),items:s.statusOptions,variant:"outlined",density:"compact","hide-details":"",class:"me-4",label:"Status",style:{"max-width":"150px"}},null,8,["modelValue","items"]),c(z,{icon:"",size:"small",onClick:s.loadTickets,class:"ms-2"},{default:r((()=>[c(U,null,{default:r((()=>t[13]||(t[13]=[d("mdi-refresh")]))),_:1})])),_:1},8,["onClick"]),c(I)])),_:1}),c(F,{class:"pa-3 pt-0"},{default:r((()=>[c(V,{modelValue:s.searchQuery,"onUpdate:modelValue":t[1]||(t[1]=e=>s.searchQuery=e),"prepend-inner-icon":"mdi-magnify",label:"Search tickets",variant:"outlined",density:"compact","hide-details":"",onInput:s.debounceSearch},null,8,["modelValue","onInput"])])),_:1}),u("div",ae,[c($,{lines:"two","select-strategy":"single",selected:s.selectedTicket,"onUpdate:selected":t[2]||(t[2]=e=>s.selectedTicket=e)},{default:r((()=>[s.loading?(i(),m("div",se,[c(j,{indeterminate:""})])):0===s.tickets.length?(i(),m("div",le," No tickets found ")):g("",!0),(i(!0),m(v,null,p(s.tickets,(e=>(i(),o(A,{key:e.uuid,value:e.uuid,onClick:t=>s.selectTicket(e.uuid),active:s.currentTicketUuid===e.uuid,lines:"two",density:"compact"},{prepend:r((()=>[c(R,{color:s.getInitialColor(e.creator)},{default:r((()=>[d(f(s.getInitial(e.creator)),1)])),_:2},1032,["color"])])),append:r((()=>[u("div",ne,[u("span",ie,f(s.getTimeAgo(e.created_at)),1),u("div",null,[c(L,{color:s.getStatusColor(e.status),size:"x-small",class:"text-capitalize mr-1"},{default:r((()=>[d(f(e.status),1)])),_:2},1032,["color"]),e.unread_count>0?(i(),o(H,{key:0,content:String(e.unread_count),color:"error",dot:"",size:"small"},null,8,["content"])):g("",!0)])])])),default:r((()=>[c(O,{class:"text-subtitle-1 font-weight-medium mb-1"},{default:r((()=>[d(f(e.subject),1)])),_:2},1024),c(N,{class:"text-body-2"},{default:r((()=>[d(f(s.getCreatorName(e.creator)),1)])),_:2},1024)])),_:2},1032,["value","onClick","active"])))),128))])),_:1},8,["selected"])])])),_:1})])),_:1}),c(M,{cols:"12",sm:"7",md:"8",lg:"9",class:"chat-area"},{default:r((()=>[s.currentTicketUuid?(i(),m(v,{key:1},[c(F,{class:"px-6 py-3 border-b d-flex align-center"},{default:r((()=>{var e,a,l,n;return[u("div",re,[u("h3",ce,f(null==(e=s.currentTicket)?void 0:e.subject),1),u("div",de,[u("div",ue,[c(L,{color:s.getStatusColor(null==(a=s.currentTicket)?void 0:a.status),size:"small",class:"text-capitalize mr-2"},{default:r((()=>{var e;return[d(f(null==(e=s.currentTicket)?void 0:e.status),1)]})),_:1},8,["color"]),u("span",me," Created by "+f(s.getCreatorName(null==(l=s.currentTicket)?void 0:l.creator)),1)]),u("span",ge,f(s.formatExactDateTime(null==(n=s.currentTicket)?void 0:n.created_at)),1)])]),c(P,null,{activator:r((({props:e})=>[c(z,h({icon:""},e),{default:r((()=>[c(U,null,{default:r((()=>t[16]||(t[16]=[d("mdi-dots-vertical")]))),_:1})])),_:2},1040)])),default:r((()=>[c($,null,{default:r((()=>[c(A,{onClick:t[3]||(t[3]=e=>s.updateTicketStatus("pending"))},{default:r((()=>[c(O,null,{default:r((()=>t[17]||(t[17]=[d("Mark as Pending")]))),_:1})])),_:1}),c(A,{onClick:t[4]||(t[4]=e=>s.updateTicketStatus("resolved"))},{default:r((()=>[c(O,null,{default:r((()=>t[18]||(t[18]=[d("Mark as Resolved")]))),_:1})])),_:1}),c(A,{onClick:t[5]||(t[5]=e=>s.updateTicketStatus("unresolved"))},{default:r((()=>[c(O,null,{default:r((()=>t[19]||(t[19]=[d("Mark as Unresolved")]))),_:1})])),_:1}),c(q),c(A,{onClick:t[6]||(t[6]=e=>s.showCloseDialog=!0)},{default:r((()=>[c(O,null,{default:r((()=>t[20]||(t[20]=[d("Close Ticket")]))),_:1})])),_:1})])),_:1})])),_:1})]})),_:1}),y((i(),m("div",pe,[s.loadingMessages?(i(),m("div",fe,[c(j,{indeterminate:""})])):0===s.messages.length?(i(),m("div",ve,[c(U,{size:"64",color:"grey-lighten-1",class:"mb-4"},{default:r((()=>t[21]||(t[21]=[d("mdi-message-outline")]))),_:1}),t[22]||(t[22]=u("h3",{class:"text-h6 text-medium-emphasis mb-1"},"No messages yet",-1)),t[23]||(t[23]=u("p",{class:"text-body-2 text-medium-emphasis"},"Start the conversation with the user ",-1))])):(i(!0),m(v,{key:2},p(s.groupedMessages,((e,a)=>(i(),m("div",{key:a,class:"message-group"},[u("div",he,[u("span",ye,f(s.formatDate(a)),1)]),(i(!0),m(v,null,p(e,(e=>(i(),m("div",{key:e.id,class:"mb-4"},[u("div",{class:k(["d-flex","admin"===e.sender_type?"justify-end":"justify-start"])},[u("div",{class:k(["message-wrapper","admin"===e.sender_type?"message-out":"message-in"])},[u("div",{class:k(["message-bubble pa-4 rounded-lg",["admin"===e.sender_type?"bg-primary message-admin":"bg-grey-lighten-3 message-user"]])},[e.message?(i(),m("div",{key:0,class:k(["text-body-1 message-text","admin"===e.sender_type?"text-white":""]),innerHTML:s.formatMessageText(e.message)},null,10,ke)):g("",!0),e.has_file?(i(),m("div",we,[s.isImageFile(e.file_name)?(i(),m("div",_e,[c(G,{src:`/admin/api/messages/${e.id}/download`,"max-height":"200","max-width":"300",cover:"",class:"rounded-lg","error-src":"https://placehold.co/300x200?text=Image+Not+Available"},null,8,["src"])])):g("",!0),c(z,{variant:"text",density:"compact",class:k("admin"===e.sender_type?"text-white":""),"prepend-icon":"mdi-paperclip",size:"small",href:`/admin/api/messages/${e.id}/download`,target:"_blank",download:""},{default:r((()=>[d(f(e.file_name),1)])),_:2},1032,["class","href"])])):g("",!0)],2),u("div",{class:k(["d-flex align-center mt-1","admin"===e.sender_type?"justify-end":"justify-start"])},["admin"!==e.sender_type?(i(),m(v,{key:0},[c(R,{size:"24",color:"info-lighten-1",class:"mr-2"},{default:r((()=>[d(f(s.getInitial(e.sender)),1)])),_:2},1024),u("span",xe,f(s.getCreatorName(e.sender)),1)],64)):g("",!0),u("span",Te,f(s.formatTime(e.created_at)),1),"admin"===e.sender_type?(i(),m(v,{key:1},[t[25]||(t[25]=u("span",{class:"text-caption font-weight-medium ml-2"},"You",-1)),c(R,{size:"24",color:"primary-lighten-1",class:"ml-2"},{default:r((()=>t[24]||(t[24]=[d("A")]))),_:1})],64)):g("",!0)],2)],2)],2)])))),128))])))),128))])),[[T,{smooth:!0,always:!1}]]),c(F,{class:"message-input px-4 py-3 border-t"},{default:r((()=>[s.selectedFile?(i(),m("div",be,[c(U,{icon:s.getFileIcon(s.selectedFile.name),class:"mr-2",size:"small"},null,8,["icon"]),u("div",Ce,[u("div",Se,f(s.selectedFile.name),1),u("div",Ee,f(s.formatFileSize(s.selectedFile.size)),1)]),c(z,{icon:"",size:"small",onClick:s.removeSelectedFile},{default:r((()=>[c(U,{size:"small"},{default:r((()=>t[26]||(t[26]=[d("mdi-close")]))),_:1})])),_:1},8,["onClick"])])):g("",!0),u("div",Me,[c(K,{modelValue:s.messageText,"onUpdate:modelValue":t[7]||(t[7]=e=>s.messageText=e),variant:"outlined","hide-details":"",density:"compact",rows:"2","auto-grow":"",class:"message-textarea flex-grow-1 mr-3",placeholder:"Type a message...",onKeydown:w(_(s.sendMessage,["prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),u("div",Fe,[c(z,{icon:"",class:"mr-2",onClick:s.triggerFileInput},{default:r((()=>[c(U,null,{default:r((()=>t[27]||(t[27]=[d("mdi-paperclip")]))),_:1}),u("input",{type:"file",ref:"fileInput",style:{display:"none"},onChange:t[8]||(t[8]=(...e)=>s.onFileSelected&&s.onFileSelected(...e))},null,544)])),_:1},8,["onClick"]),c(z,{color:"primary",disabled:!s.messageText&&!s.selectedFile,loading:s.sendingMessage,onClick:s.sendMessage},{default:r((()=>t[28]||(t[28]=[d(" Send ")]))),_:1},8,["disabled","loading","onClick"])])])])),_:1})],64)):(i(),o(F,{key:0,class:"fill-height d-flex align-center justify-center"},{default:r((()=>[u("div",oe,[c(U,{size:"64",color:"grey-lighten-1",class:"mb-4"},{default:r((()=>t[14]||(t[14]=[d("mdi-forum-outline")]))),_:1}),t[15]||(t[15]=u("h3",{class:"text-h6 text-medium-emphasis"},"Select a ticket to view messages",-1))])])),_:1}))])),_:1})])),_:1})])),_:1})])),_:1}),c(X,{modelValue:s.showCloseDialog,"onUpdate:modelValue":t[12]||(t[12]=e=>s.showCloseDialog=e),"max-width":"500"},{default:r((()=>[c(S,null,{default:r((()=>[c(Q,null,{default:r((()=>t[29]||(t[29]=[d("Close Ticket")]))),_:1}),c(J,null,{default:r((()=>[c(D,{modelValue:s.closeTicketStatus,"onUpdate:modelValue":t[9]||(t[9]=e=>s.closeTicketStatus=e),items:s.closeStatusOptions,label:"Resolution Status",variant:"outlined",required:""},null,8,["modelValue","items"]),c(K,{modelValue:s.closeTicketReason,"onUpdate:modelValue":t[10]||(t[10]=e=>s.closeTicketReason=e),label:"Resolution Reason",variant:"outlined",rows:"3",required:""},null,8,["modelValue"])])),_:1}),c(W,null,{default:r((()=>[c(I),c(z,{onClick:t[11]||(t[11]=e=>s.showCloseDialog=!1),variant:"text"},{default:r((()=>t[30]||(t[30]=[d("Cancel")]))),_:1}),c(z,{color:"primary",onClick:s.closeTicket,loading:s.closingTicket,disabled:!s.closeTicketReason},{default:r((()=>t[31]||(t[31]=[d(" Close Ticket ")]))),_:1},8,["onClick","loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})}],["__scopeId","data-v-a413b799"]]),ze=T({components:ee,directives:te,theme:{defaultTheme:"light"}}),Ue=b({components:{AdminSupportChat:De}});Ue.use(ze),Ue.mount("#admin-support-app"),axios.defaults.headers.common["X-CSRF-TOKEN"]=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),window.Laravel={user:{id:document.querySelector('meta[name="user-id"]').getAttribute("content")}};
