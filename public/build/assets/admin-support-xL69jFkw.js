import{_ as Ie,r as f,c as J,W as Fe,X as Ue,w as ze,Y as Ae,L as m,z as H,C as n,O as l,Z as W,$ as Le,a0 as X,a1 as M,a2 as Z,a3 as _,a4 as S,G as u,a5 as $,a6 as je,E as i,a7 as ee,v as g,a8 as te,D as T,K as P,a9 as z,aa as K,H as h,ab as ae,ac as Re,ad as A,ae as Ne,F as D,af as He,A as Oe,ag as Be,ah as Pe,y as E,ai as Ke,aj as se,ak as qe,J as Ge,al as Qe,am as Ye,an as Je,ao as We,ap as Xe,aq as Ze,R as I,n as le,S as $e,Q as et,U as tt,V as at}from"./main-DHxkGDom.js";const st={name:"AdminSupportChat",setup(){const c=f([]),a=f([]),y=f(null),t=f([]),C=f(""),L=f(!1),F=f(!1),o=f(!1),p=f(""),r=f(""),x=f(null),v=f(null),U=f(null),b=f(null),q=f(!1),O=f("resolved"),j=f(""),B=f(!1),oe=[{title:"All Tickets",value:""},{title:"Pending",value:"pending"},{title:"Resolved",value:"resolved"},{title:"Unresolved",value:"unresolved"}],ie=[{title:"Resolved",value:"resolved"},{title:"Unresolved",value:"unresolved"}],re=J(()=>y.value&&c.value.find(e=>e.uuid===y.value)||null),de=J(()=>{const e={};return a.value.forEach(s=>{const d=new Date(s.created_at).toLocaleDateString();e[d]||(e[d]=[]),e[d].push(s)}),e}),R=async()=>{const e=y.value;L.value=!0;try{const s=await I.get("/admin/api/tickets",{params:{status:r.value,search:p.value}});c.value=s.data.data,e&&c.value.some(d=>d.uuid===e)&&(y.value=e),G()}catch(s){console.error("Error loading tickets:",s),w("Error loading tickets. Please try again.","error")}finally{L.value=!1}},G=async()=>{try{const s=(await I.get("/admin/api/unread-messages")).data.tickets||{};c.value=c.value.map(d=>({...d,unread_count:s[d.uuid]||0}))}catch(e){console.error("Error loading unread counts:",e)}},Q=async e=>{F.value=!0;try{const s=await I.get(`/admin/api/tickets/${e}/messages`);a.value=s.data,await le(),v.value&&(v.value.scrollTop=v.value.scrollHeight)}catch(s){console.error("Error loading messages:",s),w("Error loading messages. Please try again.","error")}finally{F.value=!1}},ce=async()=>{if(!((!C.value||C.value.trim()==="")&&!b.value)){o.value=!0;try{const e=new FormData;C.value&&e.append("message",C.value),b.value&&e.append("file",b.value);const s=await I.post(`/admin/api/tickets/${y.value}/messages`,e,{headers:{"Content-Type":"multipart/form-data"}});a.value.push({...s.data.message,sender:s.data.sender}),C.value="",b.value=null,await le(),v.value&&(v.value.scrollTop=v.value.scrollHeight)}catch(e){console.error("Error sending message:",e),w("Error sending message. Please try again.","error")}finally{o.value=!1}}},ue=async e=>{try{await I.put(`/admin/api/tickets/${y.value}/status`,{status:e});const s=c.value.find(d=>d.uuid===y.value);s&&(s.status=e),w(`Ticket marked as ${e}`,"success")}catch(s){console.error("Error updating ticket status:",s),w("Error updating ticket status. Please try again.","error")}},me=async()=>{if(!j.value){w("Please provide a resolution reason","warning");return}B.value=!0;try{await I.post(`/admin/api/tickets/${y.value}/close`,{resolution_status:O.value,reason:j.value});const e=c.value.find(s=>s.uuid===y.value);e&&(e.status=O.value),q.value=!1,j.value="",w("Ticket closed successfully","success")}catch(e){console.error("Error closing ticket:",e),w("Error closing ticket. Please try again.","error")}finally{B.value=!1}},fe=e=>{if(!e)return"";const s=document.createElement("div");return s.textContent=e,s.innerHTML.replace(/\n/g,"<br>")},ge=e=>{switch(e){case"pending":return"warning";case"resolved":return"success";case"unresolved":return"error";default:return"grey"}},ve=e=>e?e.first_name&&e.first_name.length>0?e.first_name.charAt(0).toUpperCase():e.last_name&&e.last_name.length>0?e.last_name.charAt(0).toUpperCase():"U":"U",he=e=>e?new Date(e).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",ye=e=>{const s=["primary","secondary","info","success","warning"];if(!e||!e.email)return s[0];const d=e.email.split("").reduce((k,V)=>k+V.charCodeAt(0),0);return s[d%s.length]},pe=e=>{if(!e)return"Unknown";let s="";return e.first_name&&(s+=e.first_name),e.last_name&&(s&&(s+=" "),s+=e.last_name),s||e.email||"Unknown"},we=e=>{const s=new Date(e),d=new Date,k=new Date(d);return k.setDate(k.getDate()-1),s.toDateString()===d.toDateString()?"Today":s.toDateString()===k.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric",year:"numeric"})},xe=e=>new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),ke=e=>{if(!e)return"";const s=new Date(e),k=Math.floor((new Date-s)/1e3);if(k<60)return"Just now";const V=Math.floor(k/60);if(V<60)return`${V} min${V>1?"s":""} ago`;const N=Math.floor(V/60);if(N<24)return`${N} hour${N>1?"s":""} ago`;const Y=Math.floor(N/24);return`${Y} day${Y>1?"s":""} ago`},_e=e=>{if(!e)return!1;const s=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(s)},Te=e=>{if(!e)return"mdi-file";switch(e.split(".").pop().toLowerCase()){case"pdf":return"mdi-file-pdf";case"doc":case"docx":return"mdi-file-word";case"xls":case"xlsx":return"mdi-file-excel";case"zip":case"rar":case"7z":return"mdi-folder-zip";case"jpg":case"jpeg":case"png":case"gif":case"webp":return"mdi-file-image";default:return"mdi-file"}},Ce=e=>e<1024?e+" bytes":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB",be=(()=>{let e;return()=>{clearTimeout(e),e=setTimeout(()=>{R()},500)}})(),w=(e,s="success")=>{typeof toastr<"u"?s==="success"?toastr.success(e,"Success"):s==="error"||s==="danger"?toastr.error(e,"Error"):s==="warning"?toastr.warning(e,"Warning"):s==="info"&&toastr.info(e,"Information"):console.log(`[${s.toUpperCase()}] ${e}`)},Se=()=>{U.value&&U.value.click()},Ve=e=>{const s=e.target.files[0];if(s){if(s.size>10*1024*1024){w("File is too large. Maximum size is 10MB.","warning");return}b.value=s}},Me=()=>{b.value=null,U.value&&(U.value.value=null)},De=async e=>{y.value=e,t.value=[e],await Q(e),typeof window.Echo<"u"&&Ee(e)},Ee=async e=>{if(typeof window.Echo>"u"){console.error("Echo is not available");return}if(x.value)try{await window.Echo.leave(x.value)}catch(d){console.error("Error leaving channel:",d)}const s=`ticket.${e}`;x.value=s,console.log("window.Echo.channel(channelName):",window.Echo.channel(s));try{window.Echo.channel("channel_for_everyone").listen("GotMessage",async d=>{console.log(`Successfully subscribed to ${s}`),console.log(d,"listening to MessageCreated")}).error(d=>{console.error(`Channel error on ${s}:`,d)})}catch(d){console.error("Error subscribing to channel:",d)}};return Fe(()=>{window.Echo.channel("channel_for_everyone").listen("GotMessage",s=>{console.log(s)}),window.Echo.channel("channel_for_everyone").listen(".GotMessage",s=>{console.log(s)}),Echo.channel("channel_for_everyone").listen("GotMessage",s=>{console.log("Received message via Echo:",s)}),R();const e=setInterval(()=>{G()},6e4);Ue(()=>{clearInterval(e),x.value&&typeof window.Echo<"u"&&window.Echo.leave(x.value)})}),ze(r,()=>{R()}),{tickets:c,messages:a,currentTicketUuid:y,selectedTicket:t,messageText:C,loading:L,loadingMessages:F,sendingMessage:o,searchQuery:p,statusFilter:r,messagesContainer:v,fileInput:U,selectedFile:b,showCloseDialog:q,closeTicketStatus:O,closeTicketReason:j,closingTicket:B,currentTicket:re,groupedMessages:de,statusOptions:oe,closeStatusOptions:ie,formatExactDateTime:he,loadTickets:R,selectTicket:De,loadMessages:Q,sendMessage:ce,updateTicketStatus:ue,closeTicket:me,formatMessageText:fe,getStatusColor:ge,getInitial:ve,getInitialColor:ye,getCreatorName:pe,formatDate:we,formatTime:xe,getTimeAgo:ke,isImageFile:_e,getFileIcon:Te,formatFileSize:Ce,debounceSearch:be,triggerFileInput:Se,onFileSelected:Ve,removeSelectedFile:Me}},directives:{"chat-scroll":{mounted(c,a){const y=a.value||{};c.scrollTop=c.scrollHeight;const t=new MutationObserver(()=>{(y.always||c.scrollTop+c.clientHeight+100>=c.scrollHeight)&&setTimeout(()=>{c.scrollTop=c.scrollHeight},0)});t.observe(c,{childList:!0,subtree:!0}),c._chatScrollObserver=t},unmounted(c){c._chatScrollObserver&&c._chatScrollObserver.disconnect()}}}},lt={class:"ticket-list flex-grow-1 overflow-auto"},nt={key:0,class:"d-flex justify-center py-6"},ot={key:1,class:"text-center pa-4 text-body-2 text-medium-emphasis"},it={class:"d-flex flex-column align-end"},rt={class:"text-caption text-medium-emphasis mb-1"},dt={class:"text-center"},ct={class:"flex-grow-1"},ut={class:"text-h6 mb-1"},mt={class:"d-flex flex-column"},ft={class:"d-flex align-center mb-1"},gt={class:"text-caption text-medium-emphasis"},vt={class:"text-caption text-medium-emphasis"},ht={ref:"messagesContainer",class:"messages-container flex-grow-1 overflow-auto pa-6"},yt={key:0,class:"d-flex justify-center py-6"},pt={key:1,class:"text-center"},wt={class:"date-separator text-center my-6"},xt={class:"text-caption bg-grey-lighten-3 px-3 py-1 rounded"},kt=["innerHTML"],_t={key:1,class:"mt-2"},Tt={key:0,class:"text-center mb-2"},Ct={class:"text-caption font-weight-medium mr-2"},bt={class:"text-caption text-medium-emphasis"},St={key:0,class:"selected-file mb-2 pa-2 rounded bg-grey-lighten-4 d-flex align-center"},Vt={class:"flex-grow-1"},Mt={class:"text-body-2"},Dt={class:"text-caption"},Et={class:"d-flex align-center"},It={class:"d-flex align-center"};function Ft(c,a,y,t,C,L){const F=Ae("chat-scroll");return m(),H(Ze,null,{default:n(()=>[l(Qe,{fluid:"",class:"fill-height pa-0 w-100"},{default:n(()=>[l(W,{class:"rounded-lg elevation-2 fill-height overflow-hidden w-100"},{default:n(()=>[l(Le,{class:"fill-height w-100"},{default:n(()=>[l(X,{cols:"12",sm:"5",md:"4",lg:"3",class:"ticket-sidebar"},{default:n(()=>[l(M,{class:"fill-height d-flex flex-column"},{default:n(()=>[l(M,{class:"pa-3 d-flex align-center"},{default:n(()=>[l(Z,{modelValue:t.statusFilter,"onUpdate:modelValue":a[0]||(a[0]=o=>t.statusFilter=o),items:t.statusOptions,variant:"outlined",density:"compact","hide-details":"",class:"me-4",label:"Status",style:{"max-width":"150px"}},null,8,["modelValue","items"]),l(_,{icon:"",size:"small",onClick:t.loadTickets,class:"ms-2"},{default:n(()=>[l(S,null,{default:n(()=>a[13]||(a[13]=[u("mdi-refresh")])),_:1})]),_:1},8,["onClick"]),l($)]),_:1}),l(M,{class:"pa-3 pt-0"},{default:n(()=>[l(je,{modelValue:t.searchQuery,"onUpdate:modelValue":a[1]||(a[1]=o=>t.searchQuery=o),"prepend-inner-icon":"mdi-magnify",label:"Search tickets",variant:"outlined",density:"compact","hide-details":"",onInput:t.debounceSearch},null,8,["modelValue","onInput"])]),_:1}),i("div",lt,[l(ee,{lines:"two","select-strategy":"single",selected:t.selectedTicket,"onUpdate:selected":a[2]||(a[2]=o=>t.selectedTicket=o)},{default:n(()=>[t.loading?(m(),g("div",nt,[l(te,{indeterminate:""})])):t.tickets.length===0?(m(),g("div",ot," No tickets found ")):T("",!0),(m(!0),g(D,null,P(t.tickets,o=>(m(),H(z,{key:o.uuid,value:o.uuid,onClick:p=>t.selectTicket(o.uuid),active:t.currentTicketUuid===o.uuid,lines:"two",density:"compact"},{prepend:n(()=>[l(K,{color:t.getInitialColor(o.creator)},{default:n(()=>[u(h(t.getInitial(o.creator)),1)]),_:2},1032,["color"])]),append:n(()=>[i("div",it,[i("span",rt,h(t.getTimeAgo(o.created_at)),1),i("div",null,[l(ae,{color:t.getStatusColor(o.status),size:"x-small",class:"text-capitalize mr-1"},{default:n(()=>[u(h(o.status),1)]),_:2},1032,["color"]),o.unread_count>0?(m(),H(Re,{key:0,content:String(o.unread_count),color:"error",dot:"",size:"small"},null,8,["content"])):T("",!0)])])]),default:n(()=>[l(A,{class:"text-subtitle-1 font-weight-medium mb-1"},{default:n(()=>[u(h(o.subject),1)]),_:2},1024),l(Ne,{class:"text-body-2"},{default:n(()=>[u(h(t.getCreatorName(o.creator)),1)]),_:2},1024)]),_:2},1032,["value","onClick","active"]))),128))]),_:1},8,["selected"])])]),_:1})]),_:1}),l(X,{cols:"12",sm:"7",md:"8",lg:"9",class:"chat-area"},{default:n(()=>[t.currentTicketUuid?(m(),g(D,{key:1},[l(M,{class:"px-6 py-3 border-b d-flex align-center"},{default:n(()=>{var o,p,r,x;return[i("div",ct,[i("h3",ut,h((o=t.currentTicket)==null?void 0:o.subject),1),i("div",mt,[i("div",ft,[l(ae,{color:t.getStatusColor((p=t.currentTicket)==null?void 0:p.status),size:"small",class:"text-capitalize mr-2"},{default:n(()=>{var v;return[u(h((v=t.currentTicket)==null?void 0:v.status),1)]}),_:1},8,["color"]),i("span",gt," Created by "+h(t.getCreatorName((r=t.currentTicket)==null?void 0:r.creator)),1)]),i("span",vt,h(t.formatExactDateTime((x=t.currentTicket)==null?void 0:x.created_at)),1)])]),l(He,null,{activator:n(({props:v})=>[l(_,Oe({icon:""},v),{default:n(()=>[l(S,null,{default:n(()=>a[16]||(a[16]=[u("mdi-dots-vertical")])),_:1})]),_:2},1040)]),default:n(()=>[l(ee,null,{default:n(()=>[l(z,{onClick:a[3]||(a[3]=v=>t.updateTicketStatus("pending"))},{default:n(()=>[l(A,null,{default:n(()=>a[17]||(a[17]=[u("Mark as Pending")])),_:1})]),_:1}),l(z,{onClick:a[4]||(a[4]=v=>t.updateTicketStatus("resolved"))},{default:n(()=>[l(A,null,{default:n(()=>a[18]||(a[18]=[u("Mark as Resolved")])),_:1})]),_:1}),l(z,{onClick:a[5]||(a[5]=v=>t.updateTicketStatus("unresolved"))},{default:n(()=>[l(A,null,{default:n(()=>a[19]||(a[19]=[u("Mark as Unresolved")])),_:1})]),_:1}),l(Be),l(z,{onClick:a[6]||(a[6]=v=>t.showCloseDialog=!0)},{default:n(()=>[l(A,null,{default:n(()=>a[20]||(a[20]=[u("Close Ticket")])),_:1})]),_:1})]),_:1})]),_:1})]}),_:1}),Pe((m(),g("div",ht,[t.loadingMessages?(m(),g("div",yt,[l(te,{indeterminate:""})])):t.messages.length===0?(m(),g("div",pt,[l(S,{size:"64",color:"grey-lighten-1",class:"mb-4"},{default:n(()=>a[21]||(a[21]=[u("mdi-message-outline")])),_:1}),a[22]||(a[22]=i("h3",{class:"text-h6 text-medium-emphasis mb-1"},"No messages yet",-1)),a[23]||(a[23]=i("p",{class:"text-body-2 text-medium-emphasis"},"Start the conversation with the user ",-1))])):(m(!0),g(D,{key:2},P(t.groupedMessages,(o,p)=>(m(),g("div",{key:p,class:"message-group"},[i("div",wt,[i("span",xt,h(t.formatDate(p)),1)]),(m(!0),g(D,null,P(o,r=>(m(),g("div",{key:r.id,class:"mb-4"},[i("div",{class:E(["d-flex",r.sender_type==="admin"?"justify-end":"justify-start"])},[i("div",{class:E(["message-wrapper",r.sender_type==="admin"?"message-out":"message-in"])},[i("div",{class:E(["message-bubble pa-4 rounded-lg",[r.sender_type==="admin"?"bg-primary message-admin":"bg-grey-lighten-3 message-user"]])},[r.message?(m(),g("div",{key:0,class:E(["text-body-1 message-text",r.sender_type==="admin"?"text-white":""]),innerHTML:t.formatMessageText(r.message)},null,10,kt)):T("",!0),r.has_file?(m(),g("div",_t,[t.isImageFile(r.file_name)?(m(),g("div",Tt,[l(Ke,{src:`/admin/api/messages/${r.id}/download`,"max-height":"200","max-width":"300",cover:"",class:"rounded-lg","error-src":"https://placehold.co/300x200?text=Image+Not+Available"},null,8,["src"])])):T("",!0),l(_,{variant:"text",density:"compact",class:E(r.sender_type==="admin"?"text-white":""),"prepend-icon":"mdi-paperclip",size:"small",href:`/admin/api/messages/${r.id}/download`,target:"_blank",download:""},{default:n(()=>[u(h(r.file_name),1)]),_:2},1032,["class","href"])])):T("",!0)],2),i("div",{class:E(["d-flex align-center mt-1",r.sender_type==="admin"?"justify-end":"justify-start"])},[r.sender_type!=="admin"?(m(),g(D,{key:0},[l(K,{size:"24",color:"info-lighten-1",class:"mr-2"},{default:n(()=>[u(h(t.getInitial(r.sender)),1)]),_:2},1024),i("span",Ct,h(t.getCreatorName(r.sender)),1)],64)):T("",!0),i("span",bt,h(t.formatTime(r.created_at)),1),r.sender_type==="admin"?(m(),g(D,{key:1},[a[25]||(a[25]=i("span",{class:"text-caption font-weight-medium ml-2"},"You",-1)),l(K,{size:"24",color:"primary-lighten-1",class:"ml-2"},{default:n(()=>a[24]||(a[24]=[u("A")])),_:1})],64)):T("",!0)],2)],2)],2)]))),128))]))),128))])),[[F,{smooth:!0,always:!1}]]),l(M,{class:"message-input px-4 py-3 border-t"},{default:n(()=>[t.selectedFile?(m(),g("div",St,[l(S,{icon:t.getFileIcon(t.selectedFile.name),class:"mr-2",size:"small"},null,8,["icon"]),i("div",Vt,[i("div",Mt,h(t.selectedFile.name),1),i("div",Dt,h(t.formatFileSize(t.selectedFile.size)),1)]),l(_,{icon:"",size:"small",onClick:t.removeSelectedFile},{default:n(()=>[l(S,{size:"small"},{default:n(()=>a[26]||(a[26]=[u("mdi-close")])),_:1})]),_:1},8,["onClick"])])):T("",!0),i("div",Et,[l(se,{modelValue:t.messageText,"onUpdate:modelValue":a[7]||(a[7]=o=>t.messageText=o),variant:"outlined","hide-details":"",density:"compact",rows:"2","auto-grow":"",class:"message-textarea flex-grow-1 mr-3",placeholder:"Type a message...",onKeydown:qe(Ge(t.sendMessage,["prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),i("div",It,[l(_,{icon:"",class:"mr-2",onClick:t.triggerFileInput},{default:n(()=>[l(S,null,{default:n(()=>a[27]||(a[27]=[u("mdi-paperclip")])),_:1}),i("input",{type:"file",ref:"fileInput",style:{display:"none"},onChange:a[8]||(a[8]=(...o)=>t.onFileSelected&&t.onFileSelected(...o))},null,544)]),_:1},8,["onClick"]),l(_,{color:"primary",disabled:!t.messageText&&!t.selectedFile,loading:t.sendingMessage,onClick:t.sendMessage},{default:n(()=>a[28]||(a[28]=[u(" Send ")])),_:1},8,["disabled","loading","onClick"])])])]),_:1})],64)):(m(),H(M,{key:0,class:"fill-height d-flex align-center justify-center"},{default:n(()=>[i("div",dt,[l(S,{size:"64",color:"grey-lighten-1",class:"mb-4"},{default:n(()=>a[14]||(a[14]=[u("mdi-forum-outline")])),_:1}),a[15]||(a[15]=i("h3",{class:"text-h6 text-medium-emphasis"},"Select a ticket to view messages",-1))])]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1}),l(Xe,{modelValue:t.showCloseDialog,"onUpdate:modelValue":a[12]||(a[12]=o=>t.showCloseDialog=o),"max-width":"500"},{default:n(()=>[l(W,null,{default:n(()=>[l(Ye,null,{default:n(()=>a[29]||(a[29]=[u("Close Ticket")])),_:1}),l(Je,null,{default:n(()=>[l(Z,{modelValue:t.closeTicketStatus,"onUpdate:modelValue":a[9]||(a[9]=o=>t.closeTicketStatus=o),items:t.closeStatusOptions,label:"Resolution Status",variant:"outlined",required:""},null,8,["modelValue","items"]),l(se,{modelValue:t.closeTicketReason,"onUpdate:modelValue":a[10]||(a[10]=o=>t.closeTicketReason=o),label:"Resolution Reason",variant:"outlined",rows:"3",required:""},null,8,["modelValue"])]),_:1}),l(We,null,{default:n(()=>[l($),l(_,{onClick:a[11]||(a[11]=o=>t.showCloseDialog=!1),variant:"text"},{default:n(()=>a[30]||(a[30]=[u("Cancel")])),_:1}),l(_,{color:"primary",onClick:t.closeTicket,loading:t.closingTicket,disabled:!t.closeTicketReason},{default:n(()=>a[31]||(a[31]=[u(" Close Ticket ")])),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Ut=Ie(st,[["render",Ft],["__scopeId","data-v-a413b799"]]),zt=$e({components:tt,directives:at,theme:{defaultTheme:"light"}}),ne=et({components:{AdminSupportChat:Ut}});ne.use(zt);ne.mount("#admin-support-app");axios.defaults.headers.common["X-CSRF-TOKEN"]=document.querySelector('meta[name="csrf-token"]').getAttribute("content");window.Laravel={user:{id:document.querySelector('meta[name="user-id"]').getAttribute("content")}};
