import{u as h,b as f,c as m,r as y}from"./app-DZGKe3Aq.js";import{_ as v,v as a,E as s,J as p,O as w,C as b,H as g,D as T,F as x,K as P,G as O,y as I,M as k,L as i,ak as L}from"./main-DHxkGDom.js";import{i as C}from"./intracard-vz8Mx2b7.js";const S={setup(){return{logout:h().logout}},data(){return{otp:Array(6).fill(""),loading:!1,resendLoading:!1,error:null,countdownTime:300,intervalId:null}},computed:{isFormValid(){return this.otp.every(t=>t!=="")&&this.otp.join("").length===6},countdown(){const t=Math.floor(this.countdownTime/60),e=this.countdownTime%60;return`${t}:${e.toString().padStart(2,"0")}`}},methods:{handleInput(t,e){const o=e.target.value;/^[0-9]$/.test(o)?(this.otp[t]=o,t<5&&this.$refs.otpInputs[t+1].focus()):e.target.value=""},handleBackspace(t,e){e.target.value===""?(this.otp[t]="",t>0&&this.$refs.otpInputs[t-1].focus()):this.otp[t]=""},async resendOTP(){const t=f();this.resendLoading=!0;try{const e=await m.post("/auth/otp-resend");console.log(e),e.data.success?(t.success(e.data.message||"OTP resent successfully!",{timeout:3e3}),this.countdownTime=300,localStorage.setItem("otpCountdown",Math.floor(Date.now()/1e3)+300)):t.error(e.data.message||"Failed to resend OTP.",{timeout:5e3})}catch{t.error("Failed to resend OTP. Please try again later.",{timeout:5e3})}finally{this.resendLoading=!1}},async verifyOTP(){const t=f();this.loading=!0,this.error=null;try{const e=this.otp.join("");if(!this.isFormValid)throw new Error("Please fill in all the OTP boxes.");console.log(e);const o=await m.post("/auth/otp-verify",{otp_code:e});if(o.data.success){const l=h();await l.updateUserState({...l.user,otp_verified:!0}),t.success(o.data.message||"OTP verified successfully!",{timeout:3e3}),y.push(o.data.redirect_url||"/dashboard");return}else t.error(o.data.message||"Failed to verify OTP.",{timeout:5e3})}catch(e){if(e.message==="Please fill in all the OTP boxes.")this.error=e.message,t.error(this.error,{timeout:5e3});else if(e.response)if(e.response.status===422){const o=e.response.data.errors||{},l=Object.values(o)[0][0]||"Validation failed.";this.error=l,t.error(l,{timeout:5e3})}else e.response.status===409?(this.error=e.response.data.message||"Invalid or expired OTP.",t.error(this.error,{timeout:5e3})):(this.error=e.response.data.message||"An unexpected server error occurred.",t.error(this.error,{timeout:5e3}));else e.request?(this.error="No response from the server. Please try again.",t.error(this.error,{timeout:5e3})):(this.error="An error occurred while verifying OTP.",t.error(this.error,{timeout:5e3}))}finally{this.loading=!1}},startCountdown(){const t=localStorage.getItem("otpCountdown"),e=Math.floor(Date.now()/1e3);t&&t>e?this.countdownTime=t-e:(this.countdownTime=300,localStorage.setItem("otpCountdown",e+300)),this.intervalId=setInterval(()=>{this.countdownTime>0?this.countdownTime--:clearInterval(this.intervalId)},1e3)},async handleLogout(){const t=f();try{await this.logout()}catch{t.error("Logout failed. Please try again.",{timeout:5e3})}}},mounted(){this.startCountdown()},beforeUnmount(){clearInterval(this.intervalId)}},V={class:"d-flex flex-column flex-root",id:"kt_app_root"},F={class:"d-flex flex-column flex-xl-row flex-column-fluid"},E={class:"container"},B={class:"center-div"},M={class:"flex-row-fluid flex-center justfiy-content-xl-first p-10"},N={class:""},j={class:"text-center mb-9"},A={class:"fv-row mb-5 text-center"},D={key:0,class:"text-danger mb-3"},K={class:"otp-container"},q=["onInput","onKeydown"],R={class:"text-center mt-9"},U=["disabled"],z={key:0},G={key:1},H={class:"text-center"},J={class:"mt-4"},Q={class:"text-black"},W={class:"countdown"},X=["disabled"],Y={key:0},Z={key:1};function $(t,e,o,l,n,r){const _=k("router-link");return i(),a("div",V,[s("div",F,[s("div",E,[s("div",B,[s("div",M,[s("div",N,[s("form",{class:"form",novalidate:"novalidate",onSubmit:e[2]||(e[2]=p((...d)=>r.verifyOTP&&r.verifyOTP(...d),["prevent"]))},[s("div",j,[w(_,{class:"mb-15",to:""},{default:b(()=>e[3]||(e[3]=[s("img",{alt:"Logo",src:C,class:"h-100px"},null,-1)])),_:1}),e[4]||(e[4]=s("h2",{class:"text-gray-900 mb-3"},"Verify OTP",-1)),e[5]||(e[5]=s("div",{class:"text-gray-500 fw-semibold fs-4"}," Enter the OTP code sent to your email ",-1))]),s("div",A,[n.error?(i(),a("p",D,g(n.error),1)):T("",!0),s("div",K,[(i(),a(x,null,P(6,(d,c)=>s("input",{key:c,ref_for:!0,ref:"otpInputs",maxlength:1,type:"text",class:"otp-box",onInput:u=>r.handleInput(c,u),onKeydown:L(u=>r.handleBackspace(c,u),["backspace"])},null,40,q)),64))]),s("div",R,[s("button",{class:"btn btn-dark",type:"submit",disabled:!r.isFormValid||n.loading},[n.loading?(i(),a("span",G,"Verifying...")):(i(),a("span",z,"Verify & Proceed"))],8,U)])]),s("div",H,[s("button",{onClick:e[0]||(e[0]=(...d)=>r.handleLogout&&r.handleLogout(...d)),class:"btn btn-outline-danger-custom mt-2",type:"button"},"Logout"),s("div",J,[s("p",Q,[e[6]||(e[6]=O(" If you haven't received your OTP, you can request it again in ")),s("span",W,g(r.countdown),1)]),s("button",{class:I([{"btn-secondary":n.countdownTime>0,"btn-primary":n.countdownTime===0},"btn"]),disabled:n.countdownTime>0||n.resendLoading,onClick:e[1]||(e[1]=p((...d)=>r.resendOTP&&r.resendOTP(...d),["prevent"])),type:"button"},[n.resendLoading?(i(),a("span",Y,"Resending...")):(i(),a("span",Z,"Resend OTP"))],10,X)])])],32)])])])])])])}const oe=v(S,[["render",$],["__scopeId","data-v-f7ce6764"]]);export{oe as default};
